<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.14.1/css/ol.css" type="text/css">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/openlayers/4.6.5/ol.css" type="text/css"> -->
    <link href="https://cdn.bootcdn.net/ajax/libs/zTree.v3/3.5.42/css/metroStyle/metroStyle.css" rel="stylesheet">
    
    <style>
        html,
        body,
        .map {
            /* margin: 0;
            padding: 0; */
            width: 100%;
            height: 100%;
        }
        /* .map {
        height: 1080px;
        width: 100%;
      } */
        .map .ol-rotate {
            top: 3em;
            left: .5em;
            right: auto;
        }
        .locateMe {
            position:absolute;
            top: .5em;
            left:.5em;
        }
        .ol-zoom {
            top: .5em;
            left: 4.5em;
        }
        .ol-full-screen {
            left: 2.5em;
            top: .5em;
            right: auto;
        }
        #mouse-position {
            position: absolute;
            float: left;
            bottom: 0;
            z-index: 1;
            background-color: #fff;
            /* display: inline-block; */
            box-shadow: 0 0 5px #bbb;
            padding: 0 5px;
            color: #333;
        }

        #ztreeMenu {
            width: 20%;
            height: 80%;
            background-color: rgba(255, 255, 255, 0.815);
            top: 0px;
            left: 20px;
            position: absolute;
            z-index: 1;
            overflow: scroll;
            margin-top: 80px;
            overflow-y: auto;
            overflow-x: scroll;
            color: #333;
            box-shadow: 0 0 5px #bbb;
        }

        .layer-switcher {
            top: 4em;
            left:.5em;
        }

        .layer-switcher button {
            width: 20px;
            height: 20px;
            background-position: center
        }

        #menu {
            position: absolute;
            right: 3%;
            top: 2%;
            z-index: 1;
            background-color: #fff;
            box-shadow: 0 0 15px #bbb;
            padding: 3px;
            border-radius: 5px;
            color: #333;
        }
    </style>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.14.1/build/ol.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/openlayers/4.6.5/ol.js"></script> -->
    <script src="https://cdn.bootcdn.net/ajax/libs/zTree.v3/3.5.42/js/jquery.ztree.all.js"></script>
    <title>a-webmap-to-show-route</title>
</head>

<body>
    <!-- <h2>a Map</h2> -->
    <div id="map" class="map"></div>
    <div id="ztreeMenu" style="">
        <input style="width: 96%;" type="text" id="geojson_id" placeholder="粘贴路线id"/>
        <button id="ajaxJump" onclick="AjaxJson();">直接获得</button>
        <button id="jumpJson" onclick="openRoute();">跳转6只脚</button>
        <button id="jump" onclick="openRouteJson();">去6只脚手动复制json</button>
        <button id="uploadTxt" onclick="uploadTxt();">上传6只脚json</button>
        <button id="uploadGeojson" onclick="uploadGeojson();">上传geojsonjson</button>

        <button id="clear_vector" class="btn btn-default" onclick="clearVector();">清除轨迹</button>
        <a id="image-download" download="map.png"></a>
        <!-- <button id="export-png" >导出地图</button> -->
        <input id="inputFile" type="file"    style="display: none;" id="file" />
        <textarea style="width: 96%;" rows="2" type="text" id="geojson_content" placeholder="粘贴" ></textarea>
        <button id="paste_route" onclick="showRouteFromTextarea()">加载轨迹</button>
        <button id="export_t_val" onclick="exportRawJsonData()">保存原始数据</button>
        <button id="export_v_geojson" onclick="exportVectorGeojson()">保存geojson</button>
        <button id="start-animation">开始动画</button>
        <button id="export-png" class="btn btn-default"><i class="fa fa-download"></i>导出地图</button>
        <ul id="Maptree" class="ztree" ></ul>
    </div>
    <div id="mouse-position"></div>
    <script type="text/javascript">
        var map = new ol.Map({
            target: 'map',
            controls: ol.control.defaults().extend(
                [
                    // new ol.control.OverviewMap({}),
                    new ol.control.FullScreen(),
                    new ol.control.MousePosition({
                        // coordinateFormat: ol.coordinate.createStringXY(6),
                        coordinateFormat: function (coordinate) {
                            return ol.coordinate.format(coordinate, '经度:{x} 纬度:{y}<br>', 6) + String(ol.proj.fromLonLat(coordinate));
                        },                                     
                        projection: 'EPSG:4326',
                        className: 'custom-mouse-position',
                        target: document.getElementById('mouse-position'),
                        undefinedHTML: '&nbsp;',
                    }),
                ]),
            interactions: ol.interaction.defaults().extend([
                new ol.interaction.DragRotateAndZoom()
            ]),
            layers: [],
            view: new ol.View({
                center: ol.proj.fromLonLat([100, 38.82]),
                zoom: 4
            })
        });

    var zNodes = [
        {NAME: "底图",idKey: 3,pId: 3,isParent: true,ajaxParent: false,doCheck:false,},
    ];
    ztreeXYZData = [
        {
            "mapName": "openstreetmap",
            "xyzUrl":  "http://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        },
        {
            "mapName": "thunderforest cycle",
            "xyzUrl":  "http://{a-c}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png",
        },
        {
            "mapName": "thunderforest transport",
            "xyzUrl":  "http://{a-c}.tile.thunderforest.com/transport/{z}/{x}/{y}.png",
        },
        {
            "mapName": "stamen terrain-background",
            "xyzUrl":  "http://tile.stamen.com/terrain-background/{z}/{x}/{y}.png",
        },
        {
            "mapName": "ESRI_sat",
            "xyzUrl":  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        },
        {
            "mapName": "天地图矢量",
            "xyzUrl":  'http://t' + Math.round(Math.random() * 7) + '.tianditu.com/DataServer?T=' + 'vec_w' + '&x={x}&y={y}&l={z}&tk=9e4b217e5fe502a540bcc2b454583e9b',
        },
        {
            "mapName": "天地图矢量注记",
            "xyzUrl":  'http://t' + Math.round(Math.random() * 7) + '.tianditu.com/DataServer?T=' + 'cva_w' + '&x={x}&y={y}&l={z}&tk=9e4b217e5fe502a540bcc2b454583e9b',
        },
        {
            "mapName": "天地图卫星影像",
            "xyzUrl":  'http://t' + Math.round(Math.random() * 7) + '.tianditu.com/DataServer?T=' + 'img_w' + '&x={x}&y={y}&l={z}&tk=9e4b217e5fe502a540bcc2b454583e9b',
        },
        {
            "mapName": "天地图卫星影像注记",
            "xyzUrl":  'http://t' + Math.round(Math.random() * 7) + '.tianditu.com/DataServer?T=' + 'cia_w' + '&x={x}&y={y}&l={z}&tk=9e4b217e5fe502a540bcc2b454583e9b',
        },
        {
            "mapName": "天地图地形晕染",
            "xyzUrl":  'http://t' + Math.round(Math.random() * 7) + '.tianditu.com/DataServer?T=' + 'ter_w' + '&x={x}&y={y}&l={z}&tk=9e4b217e5fe502a540bcc2b454583e9b',
        },
        {
            "mapName": "天地图地形注记",
            "xyzUrl":  'http://t' + Math.round(Math.random() * 7) + '.tianditu.com/DataServer?T=' + 'cta_w' + '&x={x}&y={y}&l={z}&tk=9e4b217e5fe502a540bcc2b454583e9b',
        },
        {
            "mapName": "天地图全球境界",
            "xyzUrl":  'http://t' + Math.round(Math.random() * 7) + '.tianditu.com/DataServer?T=' + 'ibo_w' + '&x={x}&y={y}&l={z}&tk=9e4b217e5fe502a540bcc2b454583e9b',
        },
    ];

    function returnXYZLayer(url) {
        return new ol.layer.Tile({source:new ol.source.XYZ({
            crossOrigin:'anonymous',//解决导出图片跨域问题,
            url:url
        })})
    }
    function returnTMSLayer(url) {
        return new ol.layer.Tile({
            source:new ol.source.XYZ({
                    tileUrlFunction: function (tileCoord) {
                        var z = tileCoord[0];
                        var x = tileCoord[1];
                        // var y = tileCoord[2];
                        var y = (Math.pow(2, (z)) - tileCoord[2] - 1);
                        return (url + "/" + (z-1) + "/" + x + "/" + y + ".png");
                    }
                })
        })
    }

    var wmsLayer = [];
    var setting = {
        view: {selectedMulti: false},
        check: {enable: true},
        data: {
            key: {name: "NAME",title: "NAME"},
            simpleData: {idKey:"idKey",enable: true,}
        },
        callback: {
            beforeCheck: beforeCheck,
            onClick: zTreeOnClick,
            onCheck: zTreeOnCheck,
        }
    };
    function zTreeOnClick(event, treeId, treeNode) {
        console.log(treeNode);
        console.log($(this));
        var treeObj = $.fn.zTree.getZTreeObj(String(treeId));
        if(treeNode.checked == true) {
            treeObj.checkNode(treeNode, false, false, true);
        } else {
            treeObj.checkNode(treeNode, true, true, false);
            for(var j in wmsLayer) {
                if (wmsLayer[j].name == treeNode.NAME) {
                    if(treeNode.checked == true) {
                        map.addLayer(wmsLayer[j].wms);
                        wmsLayer[j].wms.setVisible(true);
                        wmsLayer[j].wms.setZIndex(100);
                        console.log("wmsLayer[j] is :",wmsLayer[j]);
                    } 
                }
            }
        }        
    }
    function beforeCheck(treeId, treeNode) {
        return (treeNode.doCheck !== false);
    }
    function zTreeOnCheck(event, treeId, treeNode) {
        console.log("zTreeOnCheck is " + event + treeId + ","+ treeNode + ","+ treeNode.idKey + ", " + treeNode.name + "," + treeNode.checked);
        var treeObj = $.fn.zTree.getZTreeObj(String(treeId));
        var nodes = treeObj.getNodesByParam("isMap", true, null);
        console.log(treeId + ","+ treeNode.idKey + ", " + treeNode.name + "," + treeNode.checked);
   
        for(var j in wmsLayer) {
            if (wmsLayer[j].name == treeNode.NAME) {
                if(treeNode.checked == true) {
                    console.log("wmsLayer[j] is :",wmsLayer[j]);
                    map.addLayer(wmsLayer[j].wms);
                    wmsLayer[j].wms.setVisible(true);
                    wmsLayer[j].wms.setZIndex(j+1);
                } else {
                    map.removeLayer(wmsLayer[j].wms);
                }
            }
        }
    }

    var load = function () {
        MapzTreeObj = $.fn.zTree.init($("#Maptree"), setting, zNodes);
        json = ztreeXYZData;
        console.log("first the json is ",json);
        for(var i in json) {
            if (json[i].xyzUrl) {
                wmsLayer.push({"name":json[i].mapName,"wms":returnXYZLayer(json[i].xyzUrl)});
            }
            else if (json[i].tmsUrl) {
                wmsLayer.push({"name":json[i].mapName,"wms":returnTMSLayer(json[i].tmsUrl)});
            }
            json[i].idKey = Number(i) + 3000;
            json[i].NAME = json[i].mapName;
            json[i].isDefMap = true;
            json[i]['wmsurl'] = json[i].url;
            delete json[i].url;

        }
        console.log("now json is ",json);
        var treeObj = $.fn.zTree.getZTreeObj("Maptree");
        treeObj.addNodes(treeObj.getNodes()[0],0,json,true);
        treeObj.expandNode(treeObj.getNodes()[0],true,true,true);
        treeObj.checkNode(treeObj.getNodes()[0].children[7],true,true,true);
        treeObj.checkNode(treeObj.getNodes()[0].children[8],true,true,true);
        treeObj.checkNode(treeObj.getNodes()[0].children[11],true,true,true);



    };
    load();




    vectorStyle = {
        'geoMarker' : new ol.style.Style({
            image: new ol.style.Circle({
                radius: 7,
                fill: new ol.style.Fill({color: 'orange'}),
                stroke: new ol.style.Stroke({
                    color: 'white',
                    width: 6,
                }),
            }),
        }),
        'startMarker' : new ol.style.Style({
            image: new ol.style.Circle({
                radius: 7,
                fill: new ol.style.Fill({color: 'green'}),
                stroke: new ol.style.Stroke({
                    color: 'white',
                    width: 6,
                }),
            }),
        }),
        'endMarker' : new ol.style.Style({
            image: new ol.style.Circle({
                radius: 7,
                fill: new ol.style.Fill({color: 'red'}),
                stroke: new ol.style.Stroke({
                    color: 'white',
                    width: 6,
                }),
            }),
        }),
        'route' : new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'rgba(255, 255, 255, 0.2)',
            }),
            stroke: new ol.style.Stroke({
                color: 'orange',
                lineDash: [5, 5],
                width: 2
            }),
            image: new ol.style.Circle({
                radius: 5,
                stroke: new ol.style.Stroke({
                    color: 'rgba(0, 0, 0, 1)',
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(255, 255, 255, 1)'
                })
            })
        }),
        'otherStyle' : new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'green'
            }),
            stroke: new ol.style.Stroke({
                color: 'blue',
                width: 10
            }),
            image: new ol.style.Circle({
                radius: 5,
            stroke: new ol.style.Stroke({
                color: 'blue',
                width: 10
            }),
                fill: new ol.style.Fill({
                    color: 'orange'
                })
            })})
    }

    var source = new ol.source.Vector();
    var vectorLayer = new ol.layer.Vector({
        source: source,
        style: function (feature) {
            if (feature.get('type') in vectorStyle) {return vectorStyle[feature.get('type')];}
            else {return vectorStyle['otherStyle'];}
      },
    });
    var z_source = new ol.source.Vector();
    var z_vectorLayer = new ol.layer.Vector({
        source: z_source,
        style: function (feature) {
            if (feature.get('type') in vectorStyle) {return vectorStyle[feature.get('type')];}
            else {return vectorStyle['otherStyle'];}
      },
    });
    // //将绘制层添加到地图容器中
    map.addLayer(z_vectorLayer);
    map.addLayer(vectorLayer);
    // var modify = new ol.interaction.Modify({source: vectorLayer.getSource()})
    // map.addInteraction(modify);
    vectorLayer.setZIndex(5000);
    z_vectorLayer.setZIndex(5001);


    </script>
    <script>
        let animating = false;
        let distance = 0;
        let lastTime;
        lastTime = Date.now();
        let geoMarker;
        let route;
        let startMarker;
        let endMarker;
        let position;
        function showRoute(tt) {
            const linePoints = new Array();
            for (i in tt) 
            {
                linePoints.push(ol.proj.fromLonLat([tt[i][2],tt[i][1],tt[i][3]]));
            }
            var lineFeatures = new ol.Feature({type:'route','geometry': new ol.geom.LineString(linePoints),});

            vectorLayer.getSource().addFeature(lineFeatures);
            map.getView().fit(lineFeatures.getGeometry().getExtent())

            geoMarker = new ol.Feature({
                type: 'geoMarker',
                'geometry': new ol.geom.Point(ol.proj.fromLonLat([tt[0][2],tt[0][1],tt[0][3]])),
                'timeStampEtc': tt[0],
            });
            startMarker = new ol.Feature({
                type: 'startMarker',
                'geometry': new ol.geom.Point(ol.proj.fromLonLat([tt[0][2],tt[0][1],tt[0][3]])),
                'timeStampEtc': tt[0],
            });
            endMarker = new ol.Feature({
                type: 'endMarker',
                'geometry': new ol.geom.Point(ol.proj.fromLonLat([tt[tt.length-1][2],tt[tt.length-1][1],tt[tt.length-1][3]])),
                'timeStampEtc': tt[tt.length-1],
            });
            vectorLayer.getSource().addFeatures([geoMarker,startMarker,endMarker]);

            source = vectorLayer.getSource()
            route = lineFeatures.getGeometry().getCoordinates()
            vectorLayer.getSource().getFeatures()
            position = geoMarker.getGeometry().clone();
        }


        function moveFeature(event) {
            const speed = 5;
            const time = event.frameState.time;
            const elapsedTime = time - lastTime;
            distance = Math.round(distance + (speed * elapsedTime)/1e2 ) ;
            if (distance >= route.length) distance = 0 
            lastTime = time;

            const currentCoordinate = route[distance]
            position.setCoordinates(currentCoordinate);
            const vectorContext = ol.render.getVectorContext(event);
            vectorContext.setStyle(vectorStyle.geoMarker);
            vectorContext.drawGeometry(position);
            // tell OpenLayers to continue the postrender animation
            map.render();
        }

        const startButton = document.getElementById('start-animation');
        function startAnimation() {
            animating = true;
            lastTime = Date.now();
            startButton.textContent = '停止轨迹动画';
            vectorLayer.on('postrender', moveFeature);
            // hide geoMarker and trigger map render through change event
            geoMarker.setGeometry(null);
        }
        function stopAnimation() {
            animating = false;
            startButton.textContent = '开始轨迹动画';

            // Keep marker at current animation position
            geoMarker.setGeometry(position);
            vectorLayer.un('postrender', moveFeature);
        }
        startButton.addEventListener('click', function () {
            if (animating) {
            stopAnimation();
            } else {
                try {
                    if (vectorLayer.getSource().getFeatures().length < 2 ) {
                        x = document.getElementById('geojson_content').value;
                        tt = JSON.parse(String(x));
                        showRoute(tt);
                    }
                } catch (error) {}
                startAnimation();
            }
        });
        function openRoute() {
            // url = 'http://www.foooooot.com/trip/' + String(document.getElementById('geojson_id').value) + '/trackjson/';
            url = 'http://www.foooooot.com/trip/' + String(document.getElementById('geojson_id').value) ;
            window.open(url);
        }
        function openRouteJson() {
            url = 'http://www.foooooot.com/trip/' + String(document.getElementById('geojson_id').value) + '/trackjson/';
            window.open(url);
        }
        function AjaxJson() {
            url = 'getTrack.php?track_id=' + String(document.getElementById('geojson_id').value) + '';
            $.get(url,function(data){
                document.getElementById('geojson_content').value = data;
                tt = JSON.parse(String(data));
                showRoute(tt);
                // startAnimation();
                // startButton.textContent = '停止轨迹动画';
            })
        }
        function showRouteFromTextarea() {
            x = document.getElementById('geojson_content').value;
            tt = JSON.parse(String(x));
            showRoute(tt);
        }
    document.getElementById('export-png').addEventListener('click', function () {
        map.once('rendercomplete', function () {
            const mapCanvas = document.createElement('canvas');
            const size = map.getSize();
            mapCanvas.width = size[0];
            mapCanvas.height = size[1];
            const mapContext = mapCanvas.getContext('2d');
            Array.prototype.forEach.call(
            document.querySelectorAll('.ol-layer canvas'),
            function (canvas) {
                if (canvas.width > 0) {
                const opacity = canvas.parentNode.style.opacity;
                mapContext.globalAlpha = opacity === '' ? 1 : Number(opacity);
                const transform = canvas.style.transform;
                // Get the transform parameters from the style's transform matrix
                const matrix = transform
                    .match(/^matrix\(([^\(]*)\)$/)[1]
                    .split(',')
                    .map(Number);
                // Apply the transform to the export map context
                CanvasRenderingContext2D.prototype.setTransform.apply(
                    mapContext,
                    matrix
                );
                mapContext.drawImage(canvas, 0, 0);
                }
            }
            );
            if (navigator.msSaveBlob) {
            // link download attribute does not work on MS browsers
            navigator.msSaveBlob(mapCanvas.msToBlob(), 'map.png');
            } else {
            const link = document.getElementById('image-download');
            link.href = mapCanvas.toDataURL();
            link.click();
            }
        });
        map.renderSync();
    });

    function exportRaw(data, name) {
        let urlObject = window.URL || window.webkitURL || window;
        let export_blob = new Blob([data]);
        let save_link = document.createElementNS("http://www.w3.org/1999/xhtml", "a")
        save_link.href = urlObject.createObjectURL(export_blob);
        save_link.download = name;
        save_link.click();
    }

    function exportVectorGeojson() {
        // tt =vectorLayer.getSource();
        // rr = tt.getFeatures();
        // nnn = new ol.format.GeoJSON()
        // nnnn = nnn.writeFeaturesObject(rr);
        // exportRaw(JSON.stringify(nnnn),'route.json');
        exportRaw(JSON.stringify((new ol.format.GeoJSON()).writeFeaturesObject(vectorLayer.getSource().getFeatures())),'route.json');
    }

    function exportRawJsonData() {
        exportRaw(document.getElementById('geojson_content').value,'route.txt');
    }

    function clearVector() {
        vectorLayer.getSource().clear();
    }

    function uploadTxt() {
        // $('#inputFile').trigger('click');
        document.getElementById('inputFile').onchange = showTxt;
        document.getElementById('inputFile').click();
        // showTxt();
    }
    function uploadGeojson() {
        document.getElementById('inputFile').onchange = showGeojson;
        document.getElementById('inputFile').click();
        // showGeojson();  
    }
    function showTxt() {
        inputFiles = document.getElementById('inputFile').files;
        if (inputFiles.length>0) {
            var inputFile = inputFiles[0];
            var fReader = new FileReader();
            fReader.readAsText(inputFile);
            fReader.onload = function() {
                document.getElementById('geojson_content').value = this.result + "\r\n";
            }
        }
    }
    function showGeojson() {
        inputFiles = document.getElementById('inputFile').files;
        if (inputFiles.length>0) {
            var inputFile = inputFiles[0];
            var fReader = new FileReader();
            fReader.readAsText(inputFile);
            fReader.onload = function() {
                vectorLayer.getSource().addFeatures((new ol.format.GeoJSON()).readFeatures(JSON.parse(this.result)));
                map.getView().fit(vectorLayer.getSource().getExtent());
                // console.log(this.result + "\r\n");
                var x = vectorLayer.getSource().getFeatures();
                for (i in x) {
                // console.log(x[i].getProperties());
                if(x[i].getProperties().type =='geoMarker') {console.log(x[i]);geoMarker = x[i];position = geoMarker.getGeometry().clone();}
                if(x[i].getProperties().type =='route') {console.log(x[i]);route = x[i].getGeometry().getCoordinates();}
                }
            }
        }
    }

    </script>
    <script>
        z_source = z_vectorLayer.getSource()
        function showMe() {
            navigator.geolocation.getCurrentPosition(function(pos){
                alert("success");
                console.log("pos is ",pos);getme(pos)},
                function(e){console.log("error is",e)},
                { // 附带参数
                    enableHighAccuracy: false, // 提高精度(耗费资源)
                    timeout: 3000, // 超过timeout则调用失败的回调函数
                    maximumAge: 1000 // 获取到的地理信息的有效期，超过有效期则重新获取一次位置信息
                }
                );
        }
        function getme(pos) {

            console.log("pos is ",pos);
            const coords = [pos.coords.longitude, pos.coords.latitude];
            const accuracy = ol.geom.Polygon.circular(coords, pos.coords.accuracy);
            z_source.clear(true);
            z_source.addFeatures([
            new ol.Feature(accuracy.transform('EPSG:4326', map.getView().getProjection())),
            new ol.Feature(new ol.geom.Point(fromLonLat(coords)))
            ]);
        }
        locate = document.createElement('div');
        locate.className = 'ol-control ol-unselectable locate';
        locate.innerHTML = '<button title="Locate me" class="locateMe">◎</button>';
        locate.addEventListener('click', function() {
            if (!z_source.isEmpty()) {
            map.getView().fit(z_source.getExtent(), {
                maxZoom: 18,
                duration: 500
            });
            }
            showMe();
        });
        map.addControl(new ol.control.Control({
            element: locate
        }));
    </script>
</body>

</html>